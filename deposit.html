<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deposit Funds</title>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&components=buttons"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Initialize Supabase
    const supabase = createClient(
      'https://nrjdmgltshosdqccaymr.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yamRtZ2x0c2hvc2RxY2NheW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzYyMjAsImV4cCI6MjA3MTYxMjIyMH0.b9H553W2PCsSNvr8HyyINl4nTSrldHN_QMQ3TVwt6qk'
    );

    // Get logged-in user
    let userId = null;
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) userId = session.user.id;

    window.userId = userId;
  </script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .method-box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 10px; width: 100%; padding: 8px; }
    #card-element { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Deposit Funds</h2>

  <label>Amount ($)</label>
  <input type="number" id="amount" min="1" step="0.01" value="10">

  <label>Select Payment Method</label>
  <select id="payment-method">
    <option value="stripe">Card / Bank</option>
    <option value="paypal">PayPal / Venmo</option>
    <option value="zelle">Zelle</option>
    <option value="chime">Chime</option>
    <option value="one">One Finance</option>
  </select>

  <!-- Stripe -->
  <div id="stripe-box" class="method-box">
    <h3>Card / Bank Info</h3>
    <div id="card-element"></div>
    <button id="stripe-deposit">Deposit with Card</button>
  </div>

  <!-- PayPal -->
  <div id="paypal-box" class="method-box" style="display:none;">
    <h3>Pay with PayPal / Venmo</h3>
    <div id="paypal-button-container"></div>
  </div>

  <!-- Manual -->
  <div id="manual-box" class="method-box" style="display:none;">
    <h3>Manual Transfer Instructions</h3>
    <p id="manual-text"></p>
    <button id="manual-deposit">Mark Deposit Complete</button>
  </div>

  <script>
    const stripe = Stripe("YOUR_STRIPE_PUBLISHABLE_KEY");
    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const paymentSelect = document.getElementById("payment-method");
    const stripeBox = document.getElementById("stripe-box");
    const paypalBox = document.getElementById("paypal-box");
    const manualBox = document.getElementById("manual-box");
    const manualText = document.getElementById("manual-text");

    paymentSelect.addEventListener("change", () => {
      const method = paymentSelect.value;
      stripeBox.style.display = method === "stripe" ? "block" : "none";
      paypalBox.style.display = method === "paypal" ? "block" : "none";
      manualBox.style.display = ["zelle","chime","one"].includes(method) ? "block" : "none";

      if(method === "zelle") manualText.textContent = "Send your deposit to: zelle@email.com";
      if(method === "chime") manualText.textContent = "Send your deposit to your Chime account manually.";
      if(method === "one") manualText.textContent = "Send your deposit to your One Finance account manually.";
    });

    // Stripe deposit
    document.getElementById("stripe-deposit").addEventListener("click", async () => {
      const amount = parseFloat(document.getElementById("amount").value);
      if(!window.userId) return alert("Please log in first.");
      const { paymentMethod, error } = await stripe.createPaymentMethod({ type: "card", card });
      if(error) return alert(error.message);

      const response = await fetch("https://oakline-bank.vercel.app/api/deposit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          paymentMethodId: paymentMethod.id,
          userId: window.userId,
          method: "stripe"
        }),
      });
      const result = await response.json();
      alert(result.success ? "Deposit successful!" : "Deposit failed: " + result.message);
    });

    // PayPal
    paypal.Buttons({
      createOrder: (data, actions) => {
        const amount = parseFloat(document.getElementById("amount").value);
        return actions.order.create({ purchase_units: [{ amount: { value: amount.toFixed(2) } }] });
      },
      onApprove: async (data, actions) => {
        await actions.order.capture();
        const response = await fetch("https://oakline-bank.vercel.app/api/deposit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: parseFloat(document.getElementById("amount").value),
            userId: window.userId,
            method: "paypal"
          }),
        });
        const result = await response.json();
        alert(result.success ? "Deposit successful via PayPal!" : "Deposit failed: " + result.message);
      }
    }).render("#paypal-button-container");

    // Manual
    document.getElementById("manual-deposit").addEventListener("click", async () => {
      const method = paymentSelect.value;
      const amount = parseFloat(document.getElementById("amount").value);
      if(!window.userId) return alert("Please log in first.");
      const response = await fetch("https://oakline-bank.vercel.app/api/deposit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          userId: window.userId,
          method
        }),
      });
      const result = await response.json();
      alert(result.success ? "Manual deposit logged!" : "Deposit failed: " + result.message);
    });
  </script>
</body>
</html>

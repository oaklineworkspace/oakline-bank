<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deposit History</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://nrjdmgltshosdqccaymr.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yamRtZ2x0c2hvc2RxY2NheW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzYyMjAsImV4cCI6MjA3MTYxMjIyMH0.b9H553W2PCsSNvr8HyyINl4nTSrldHN_QMQ3TVwt6qk'
    );

    let userId = null;
    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) userId = session.user.id;

    function formatTransactionId() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    function formatDate(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString();
    }

    async function loadHistory() {
      if(!userId) return alert("Please log in first.");

      const { data, error } = await supabase
        .from('deposits')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      if(error) return alert("Error loading deposits: " + error.message);

      const table = document.getElementById("history-table");
      table.innerHTML = "";

      data.forEach(d => {
        // If manual method, fake a realistic transaction ID and mark completed
        let txId = d.transaction_id;
        let status = d.status;

        if(["zelle","chime","one"].includes(d.method)) {
          txId = "TX-" + formatTransactionId();
          status = "completed"; // always show manual deposits as completed
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${txId}</td>
          <td>$${parseFloat(d.amount).toFixed(2)}</td>
          <td>${d.method.charAt(0).toUpperCase() + d.method.slice(1)}</td>
          <td>${status.charAt(0).toUpperCase() + status.slice(1)}</td>
          <td>${formatDate(d.created_at)}</td>
        `;
        table.appendChild(row);
      });
    }

    window.onload = loadHistory;
  </script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f8f8f8; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 5px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #4CAF50; color: white; }
    tr:hover { background: #f1f1f1; }
  </style>
</head>
<body>
  <h2>Deposit History</h2>
  <table>
    <thead>
      <tr>
        <th>Transaction ID</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="history-table"></tbody>
  </table>
</body>
</html>
